---
title: 内网穿透-远程连接家里主机
tags: 
- 内网穿透
- liunx
- 远程连接
categories:
- linux
---

> ### 一、需求场景&描述

人在公司，在家写的文档需要修改，这时就有远程连接家里电脑的需求。

之前也用过一些第三方软件，比如向日葵、ToDesk、还有一些专业的内网穿透工具，比如cpolar。使用感觉还是不够流畅，可以做一些简单的操作，但如果需要长时间写文档或者代码，体验还是有点不太适应。

所以，自己通过服务器来做内网穿透，访问家里的主机。

内网穿透的核心思想就是“映射”和“转发”，把内网设备的端口映射到公网设备的端口上，来进行流量转发。

![img](https://cdn.sspai.com/2022/05/17/db42d70e69013af8c4944a5fc1225e3b.png)

网络找的示意图如上，基础设施由两个核心设备组成：

服务端：拥有公网IP的设备一台，即上图“公网服务器”，开放2个端口7000和6000，用于公网通信。

客户端：要访问的内网设备一台，即上图"内网家用电脑"，开放实际应用服务所需的端口（比如ssh服务，默认22端口），并将配置的公网映射端口6000告知服务端。所以服务端开放的那个端口6000实际上是客户端告诉它的。

*（以上端口除22以外均为自定义端口，无特殊含义。）*

> ### 二、需要准备什么

- 家里的电脑是**Windows 10专业版**，因为只有Windows 10专业版才能使用远程桌面功能。在“开始菜单 > 设置 > 系统 > 关于”中查看系统版本，如果不是专业版，可以参考[微软官方文档：将 Windows 10 家庭版升级到 Windows 10 专业版](https://link.zhihu.com/?target=https%3A//support.microsoft.com/help/12384/)，也可以自行百度如何升级到专业版。

- 一台拥有**公网IP**的Linux服务器，用于远程端口转发。可以在各大云服务器平台上花每月不到10元获得。

> ### 三、操作步骤

### Step 1：启用远程桌面连接

在需要被远程连接的Windows 10电脑上：在“开始菜单 > 设置 > 系统 > 远程桌面”中启用远程桌面。这个远程桌面使用了微软的**RDP协议**，大部分渲染在连接设备上完成，因此**流畅度比其他基于视频传输的远程桌面软件有很大提升**。

![image-20220807213925114](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220807213925114.png)

然后打开命令行，输入`ipconfig`找到当前局域网下的IPv4地址，记录下来，用于后续局域网内连接。

![image-20220807214018927](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220807214018927.png)

### Step 2：在连接设备上安装远程桌面客户端：

在需要连接到电脑的设备上，安装一个支持RDP协议的远程桌面客户端，并且和电脑**连接到同一个局域网**下。对于不同系统的设备，我推荐以下的客户端App，你需要使用之前记录下来的IP地址和你登录Windows 10的Microsoft账户和密码来添加连接：

- **对于iOS/iPadOS设备**，在App Store安装RD Client，这是一款微软官方推出的远程桌面连接客户端App。

- **对于MacOS设备**，由于RD Client没有上架中国大陆的App Store，可以使用Parallel Client来代替。

- **对于Windows设备**，直接搜索系统自带的“远程桌面连接”工具。或者在win+r输入mstsc打开。

  

### Step 3：打开服务器的防火墙

打开云服务器的控制台，在防火墙面板里添加一条规则，放通TCP协议的3389号端口，因为RDP协议默认使用3389号端口。你也可以在设置中自定义这个端口。

### Step 4：配置服务器上的sshd服务

ssh登录服务器，编辑`/etc/ssh/sshd_config`文件（需要root权限），将其中的`#GatewayPorts no`改为`yes`并去掉注释。如果你不知道怎么使用vim编辑文件，执行下面这行命令也能达到同样的效果：

```bash
 sudo sed -i 's/#GatewayPorts no/GatewayPorts yes/' /etc/ssh/sshd_config
```

然后重启sshd服务（如果没有用可以考虑重启服务器）：

```shel
sudo systemctl restart sshd
```

将`GatewayPorts`设为`yes`可以远程端口转发绑定到一个非环回地址，进而允许其他主机连接，详见`sshd_config(5)`。

### Step 5：使用ssh进行远程端口转发

ssh命令的`-R`选项可以提供远程端口转发功能，具体命令格式如下：

```bash
ssh -NfR <服务器IP>:<服务器Port>:<本地IP>:<本地Port> <服务器用户名>@<服务器IP>
```

其中：

- **服务器IP**为你的云服务器的公网IP
- **服务器Port**为之前在防火墙中打开的端口，默认为3389
- **本地IP**一般填写`localhost`
- **本地Port**为启用远程桌面的高级设置中指定的端口，默认为3389
- **服务器用户名**为你登陆云服务器的用户名
- **`-R`**表示远程端口转发
- **`-N`**表示不执行命令，只进行端口转发
- **`-f`**表示将ssh放到后台执行

由于NAT的存在，我们无法直接从公网直接访问到局域网内的主机。远程端口转发需要由局域网内的主机主动发起，也就是在NAT上打洞，可以使得**任何访问`<服务器IP>:<服务器Port>`的请求，都会被转发到`<本地IP>:<本地Port>`**。这样，我们只需要访问`<服务器IP>:3389`，就可以连接到本地的RDP服务了。

在需要被远程连接的电脑上执行上述命令，之后不要关闭命令行，在连接设备上，把之前的局域网IP替换为服务器的公网IP，再次尝试连接。**如果一切顺利，至此，你应该能在任何有互联网连接的地方远程桌面连接到你的电脑了。**但是，现在每次电脑启动后都需要手动执行ssh命令来进行远程端口转发，比较不方便，接下来，我们使得每次开机后自动执行这个命令。

### Step 6：使用密钥认证免密登录SSH

自动执行远程端口转发命令的必要前提是ssh连接时无需输入密码，ssh提供了使用公私钥验证的方法来免密登录。首先在电脑上执行以下命令来生成公私钥：

```bash
 ssh-keygen
```

执行过程中需要确认一些参数，一路回车使用默认值即可。成功执行后该命令会在`~/.ssh`文件夹下生成`id_rsa`文件和`id_rsa.pub`文件，前者是私钥，需要妥善保管防止泄露，后者是公钥，需要保存到服务器上。可以通过执行以下命令来自动将公钥上传至服务器：

```bash
 ssh-copy-id <服务器用户名>@<服务器IP>
```

如果你的电脑上没有`ssh-copy-id`命令，可以手动将本地的`~/.ssh/id_rsa.pub`文件中的内容**全部**追加到到服务器中的`~/.ssh/authorized_keys`文件后面。如果你既没有`ssh-copy-id`命令，又不会使用vim，可以在本地执行以下命令：

```bash
 scp ~/.ssh/id_rsa.pub <服务器用户名>@<服务器IP>:~/
```

然后在服务器上执行以下命令：

```bash
 cat ~/id_rsa.pub >> ~/.ssh/authorized_keys
 rm ~/id_rsa.pub
```

ssh尝试连接服务器时，会自动匹配`~/.ssh/authorized_keys`中的公钥和你的私钥，如果成功配对，则不需要输入密码就可以连接到服务器了。

### Step 7：创建计划任务来开机自动执行（可选）

Windows提供了“任务计划程序”来实现“当某个条件满足时自动执行一个操作”的功能。打开系统自带的“任务计划程序”，在右上角点击“创建任务”，为任务添加开机启动的触发器：

高级设置中，延迟任务时间1分钟是为了等待系统进行网络连接，重复任务间隔5分钟是为了防止网络不稳定，或者超时导致掉线。掉线后可以自动重新连接。或者你也可以使用autossh等工具实现自动掉线重连等功能。

接下来为任务添加需要执行的操作，将之前建立远程端口转发的命令填写到“程序或脚本”和“添加参数”中：

然后，你可以在“条件”面板中设置只有当连接交流电源时且有网络连接时启用该任务，在“设置”面板中设置如果任务正在运行，则不要启动新任务，来避免每隔5分钟就重复执行导致的资源消耗。

> ### 四、结尾

至此，如果一切顺利，你应该可以做到在启动电脑后，不做任何操作，在任何有互联网的地方连接到你的电脑了。